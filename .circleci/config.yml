version: 2.1
orbs:
  node: circleci/node@3.0.1

executors:
  mac_exe:
    macos:
      xcode: "11.4.1"

references:
  ## Workspace
  workspace: &workspace ~/workspace

  ## Docker image configurations
  android_config: &android_config
    working_directory: *workspace
    docker:
      - image: circleci/android:api-29
    environment:
      TERM: dumb
      _JAVA_OPTIONS: "-Xmx2048m -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"
      GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m"'

commands:
  shell-script-command:
    description: "Testing command"
    steps:

      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}

      - run:
          name: Install Dependencies
          command: yarn install --immutable

      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

      - run: sh ./scripts/generate_new_version.sh

jobs:

  deploy-ocean-tokens:
    <<: *android_config
    steps:
      #- checkout
      - shell-script-command

  install-node-example:
    docker:
      - image: 'cimg/base:stable'
    steps:
      - checkout
      - run: curl -o- -L https://yarnpkg.com/install.sh | bash
      # - node/install:
      #     install-yarn: true
      # - run: node --version

workflows:
  android-test-workflow:
    jobs:
      - install-node-example:
          filters:
            branches:
              only: DSO-33-ocean-ds-lib-gen-automation

      - deploy-ocean-tokens:
          requires:
              - install-node-example
          filters:
            branches:
              only: DSO-33-ocean-ds-lib-gen-automation
